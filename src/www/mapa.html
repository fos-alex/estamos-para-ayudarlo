<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <link href="mapa.less" rel="stylesheet/less">

    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>
<body>

<div id="container" onmousedown="return false;"></div>
<div id="controlers">
    <div>
        <button onclick="addRect()">Agregar Cuadrado</button>
        <button onclick="addProd()">Agregar Producto</button>
        <select id="productos-select">
        </select>
    </div>
</div>
<script type="application/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="lib/js/kinetic/kinetic-v5.1.0.min.js"></script>
<script src="lib/js/underscore/underscore-min.js"></script>
<script src="lib/js/less/less-1.7.4.min.js"></script>
<script type="application/javascript">
var canvas = {
    objects: {
        products: {},
        shells: {}
    },
    stage: {},
    layer: {}
};
var productos = null;

$(document).ready(function () {
    $.getJSON('http://ec2-54-187-58-168.us-west-2.compute.amazonaws.com/app/productos', function (response) {
        var options = $("#productos-select");
        productos = response.data;
        $.each(productos, function(ix, el) {
            options.append($("<option />").val(ix).text(el.nombre));
        });
    });
});
function addProd() {
    var ixProducto = $("#productos-select").val();
    var selectedProd = productos[ixProducto];

    var newGroup = new Kinetic.Group({
        x: 16,
        y: 16,
        id: createId(),
        draggable: true
    });

    canvas.layer.add(newGroup);


    var prodText = new Kinetic.Text({
        x: 15,
        y: 15,
        text: selectedProd.nombre,
        fontSize: 14,
        fontFamily: 'Calibri',
        fill: 'black',
        width: selectedProd.nombre.length * 8,
        padding: 2,
        align: 'center'
    });
    newGroup.add(prodText);

    var prodImg = new Kinetic.Rect({
        x: 15,
        y: 15,
        stroke: 'black',
        strokeWidth: 3,
        width: prodText.width(),
        height: 22,
        name: name
    });
    newGroup.add(prodImg);

    canvas.layer.add(newGroup);
    canvas.objects.products[prodImg.id] = {
        id: prodImg.id,
        idProducto: selectedProd.id
    };
    canvas.layer.draw();


}

function createId(length)
{
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    length = length? length: 6;

    for( var i=0; i < length; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}

function update(activeAnchor) {
    var group = activeAnchor.getParent();

    var topLeft = group.find('.topLeft')[0];
    var topRight = group.find('.topRight')[0];
    var bottomRight = group.find('.bottomRight')[0];
    var bottomLeft = group.find('.bottomLeft')[0];
    var image = group.find('.image')[0];

    var anchorX = activeAnchor.x();
    var anchorY = activeAnchor.y();

    // update anchor positions
    switch (activeAnchor.name()) {
        case 'topLeft':
            topRight.y(anchorY);
            bottomLeft.x(anchorX);
            break;
        case 'topRight':
            topLeft.y(anchorY);
            bottomRight.x(anchorX);
            break;
        case 'bottomRight':
            bottomLeft.y(anchorY);
            topRight.x(anchorX);
            break;
        case 'bottomLeft':
            bottomRight.y(anchorY);
            topLeft.x(anchorX);
            break;
    }

    image.setPosition(topLeft.getPosition());

    var width = topRight.x() - topLeft.x();
    var height = bottomLeft.y() - topLeft.y();
    if(width && height) {
        image.setSize({width:width, height: height});
    }
}
function addAnchor(group, x, y, name) {
    var stage = group.getStage();
    var layer = group.getLayer();

    var anchor = new Kinetic.Circle({
        x: x,
        y: y,
        stroke: '#666',
        fill: '#ddd',
        strokeWidth: 2,
        radius: 4,
        name: name,
        draggable: true,
        dragOnTop: false
    });

    anchor.on('dragmove', function() {
        update(this);
        layer.draw();
    });
    anchor.on('mousedown touchstart', function() {
        group.setDraggable(false);
        this.moveToTop();
    });
    anchor.on('dragend', function() {
        group.setDraggable(true);
        layer.draw();
    });
    // add hover styling
    anchor.on('mouseover', function() {
        var layer = this.getLayer();
        document.body.style.cursor = 'pointer';
        this.setStrokeWidth(4);
        layer.draw();
    });
    anchor.on('mouseout', function() {
        var layer = this.getLayer();
        document.body.style.cursor = 'default';
        this.strokeWidth(2);
        layer.draw();
    });

    group.add(anchor);
}
function addRect(data) {

    var defaultData = {
        x: 0,
        y: 0,
        width: 200,
        height: 138,
        name: 'image',
        stroke: '#555',
        strokeWidth: 5,
        draggable: true
    };

    data = _.extend(defaultData, data);

    var newGroup = new Kinetic.Group({
        x: data.x,
        id: createId(),
        y: data.y,
        draggable: data.draggable
    });

    canvas.objects.shells[newGroup.getId()] = {
        id: newGroup.getId()
    };
    canvas.layer.add(newGroup);

    var rect = new Kinetic.Rect({
        x: data.x,
        y: data.y,
        width: data.width,
        height: data.height,
        name: data.name,
        stroke: data.stroke,
        strokeWidth: data.strokeWidth
    });

    newGroup.add(rect);
    addAnchor(newGroup, data.x, data.y, 'topLeft');
    addAnchor(newGroup, (data.x + data.width), data.y, 'topRight');
    addAnchor(newGroup, (data.x + data.width), (data.y + data.height), 'bottomRight');
    addAnchor(newGroup, data.x, (data.y + data.height), 'bottomLeft');

    newGroup.on('dragstart', function() {
        this.moveToTop();
    });

    canvas.stage.draw();
}
function initStage() {
    canvas.stage = new Kinetic.Stage({
        container: 'container',
        width: 1000,
        height: 550
    });

    canvas.layer = new Kinetic.Layer();
    canvas.stage.add(canvas.layer);

    addRect({
        x: 0,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 100,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 200,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 300,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 0,
        y: 60,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 100,
        y: 60,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 200,
        y: 60,
        width: 160,
        height: 80,
        draggable: true
    });

    addRect({
        x: 300,
        y: 60,
        width: 160,
        height: 80,
        draggable: true
    });

}

initStage();
</script>
</body>
</html>
